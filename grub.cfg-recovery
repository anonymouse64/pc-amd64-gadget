set default=0
set timeout=3

# standard cmdline params
set standard_params="console=ttyS0 console=tty1 panic=-1 systemd.gpt_auto=0 rd.systemd.unit=basic.target"

load_env --file /EFI/ubuntu/grubenv snapd_recovery_mode snapd_recovery_system

# if no default boot mode set, use install as default
if [ -z "$snapd_recovery_mode" ]; then
    set snapd_recovery_mode=install
fi

# if the recovery_mode is run, then that's the default
if [ "$snapd_recovery_mode" = "run" ]; then
    default="run"
elif [ -n "$snapd_recovery_system" ]; then
    # if we are not in run mode and we have a recovery system defined, then
    # the default is to use that system for the defined mode
    default=$snapd_recovery_mode-$snapd_recovery_system
fi

# if we can find ubuntu-boot partition, then use that to boot run mode
search --no-floppy --set=boot_fs --label ubuntu-boot

if [ -n "$boot_fs" ]; then
    default="run"
    menuentry "Continue to run mode" --hotkey=n --id=run {
        chainloader ($boot_fs)/EFI/boot/grubx64.efi
    }
fi

# globbing in grub does not sort
for label in /systems/*; do
    regexp --set 1:label "/([0-9]*)\$" "$label"
    if [ -z "$label" ]; then
        continue
    fi
    # yes, you need to backslash that less-than
    if [ -z "$best" -o "$label" \< "$best" ]; then
        set best="$label"
    fi
    # if grubenv did not pick mode-system, use best one
    if [ -z "$snapd_recovery_system" ]; then
        default=$snapd_recovery_mode-$best
    fi
    set snapd_recovery_kernel=
    load_env --file /systems/$label/grubenv snapd_recovery_kernel

    # We could "source /systems/$snapd_recovery_system/grub.cfg" here as well
    menuentry "Recover using $label" --hotkey=r --id=recover-$label $snapd_recovery_kernel recover $label {
        loopback loop $2
        chainloader (loop)/kernel.efi snapd_recovery_mode=$3 snapd_recovery_system=$4 $standard_params
    }
    menuentry "Install using $label" --hotkey=i --id=install-$label $snapd_recovery_kernel install $label {
        loopback loop $2
        chainloader (loop)/kernel.efi snapd_recovery_mode=$3 snapd_recovery_system=$4 $standard_params
    }
done

menuentry 'System setup' --hotkey=f 'uefi-firmware' {
    fwsetup
}
